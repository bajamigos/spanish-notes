<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tarea 3 SIELE S4: Diálogo de Rol | Grok Mode 🚀</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom, #000000, #0a0a0a);
      color: white;
      text-align: center;
      padding: 20px;
    }
    .recorder-card {
      margin-top: 20px;
      padding: 20px;
      border: 1px solid #1DA1F2;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.05);
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .recorder-buttons {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .recorder-button {
      background-color: #1DA1F2;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .recorder-button:hover {
      background-color: #0d8ddb;
    }
    .status-message {
      margin-top: 10px;
      color: #1DA1F2;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Tarea 3 SIELE S4: Diálogo de Rol</h1>

  <div class="recorder-card">
    <div id="recorder-display">00:00</div>
    <div class="recorder-buttons">
      <button onclick="startRecording()" class="recorder-button">🎙️ Start Record</button>
      <button onclick="stopRecording()" class="recorder-button">🛑 Stop & Send</button>
    </div>
    <div id="status" class="status-message"></div>
  </div>

  <script>
    let recorder, audioStream, audioChunks = [];
    let recordingSeconds = 0, recordingTimer;

    const statusDiv = document.getElementById("status");
    const display = document.getElementById("recorder-display");

    function updateRecorderDisplay() {
      const minutes = Math.floor(recordingSeconds / 60);
      const secs = recordingSeconds % 60;
      display.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    async function startRecording() {
      if (!navigator.mediaDevices || !window.MediaRecorder) {
        statusDiv.textContent = "🎤 Recording not supported in this browser.";
        return;
      }

      try {
        statusDiv.textContent = "🎙️ Recording...";
        audioChunks = [];
        recordingSeconds = 0;
        updateRecorderDisplay();

        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(audioStream);

        recorder.ondataavailable = e => audioChunks.push(e.data);
        recorder.start();

        recordingTimer = setInterval(() => {
          recordingSeconds++;
          updateRecorderDisplay();
          if (recordingSeconds >= 180) stopRecording(); // Auto-stop at 3 min
        }, 1000);
      } catch (err) {
        statusDiv.textContent = "❌ Error accessing microphone: " + err.message;
      }
    }

    function stopRecording() {
      if (!recorder || recorder.state !== "recording") {
        statusDiv.textContent = "⚠️ Not recording right now.";
        return;
      }

      recorder.stop();
      clearInterval(recordingTimer);
      statusDiv.textContent = "⏳ Processing recording...";

      recorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        uploadAudio(audioBlob);
      };
    }

    function uploadAudio(blob) {
      const formData = new FormData();
      formData.append('file', blob, 'recording.wav');

      fetch('https://script.google.com/macros/s/AKfycbwbPkiabXBE1hRXVomxpOxubpoiZ6xZtoi1YAT76ApicpHU482T_uHNWWbiGr8igd-Blg/exec', {
        method: 'POST',
        body: formData,
      })
        .then(response => {
          if (!response.ok) throw new Error("HTTP error " + response.status);
          return response.json();
        })
        .then(result => {
          statusDiv.textContent = "✅ Audio sent successfully!";
          const audioUrl = URL.createObjectURL(blob);
          const downloadLink = document.createElement("a");
          downloadLink.href = audioUrl;
          downloadLink.download = "recording.wav";
          downloadLink.textContent = "⬇️ Download your recording";
          downloadLink.style.display = "block";
          downloadLink.style.marginTop = "10px";
          statusDiv.appendChild(downloadLink);
        })
        .catch(error => {
          statusDiv.textContent = "❌ Upload failed: " + error.message;
        });
    }
  </script>
</body>
</html>
